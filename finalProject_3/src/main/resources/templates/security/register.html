<!DOCTYPE html>
<html th:replace="~{layout/layout_main :: layout(~{::head}, ~{::main}, ~{::script})}"
      xmlns:th="http://www.thymeleaf.org"
      lang="ko">
<head>
    <title>회원가입</title>
    <link rel="stylesheet" th:href="@{/css/security/memberRegisterForm.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body>
    <main>
        <div id="divRegisterFrm">
            <h2 class="page-title">회원가입</h2>
            
            <form name="registerFrm" enctype="multipart/form-data">
                <div class="required-notice"><span class="star">*</span> 필수입력사항</div>

                <table id="tblMemberRegister">
                    <tbody>
                        <tr>
                            <th>프로필 사진</th>
                            <td>
                                <div style="text-align: left;">
                                    <div class="profile-upload-container" onclick="openProfileModal()" style="cursor: pointer;">
                                        <img id="profilePreview" src="https://api.dicebear.com/7.x/bottts/svg?seed=1" alt="프로필 사진" class="profile-img" 
                                             onerror="this.onerror=null; this.src='https://api.dicebear.com/7.x/bottts/svg?seed=1';"/>
                                        <div class="camera-btn"><i class="fas fa-camera"></i></div>
                                    </div>
                                    <div class="address-guide" style="margin-top: 10px;">사진을 클릭하여 프로필을 설정해보세요.</div>
                                </div>
                                <input type="file" name="attach" id="attach" accept="image/*" class="file-input-hidden" onchange="previewProfileImage(this)"/>
                                <input type="hidden" name="defaultProfile" id="defaultProfile" value="" />
                            </td>
                        </tr>

                        <tr>
                            <th>이메일<span class="star">*</span></th>
                            <td>
                                <div class="input-wrapper">
                                    <input type="text" name="email" id="email" class="requiredInfo kurly-input" placeholder="예: abc@def.com" autocomplete="off" /> 
                                    <button type="button" class="btn-kurly-outline" onclick="isExistEmailCheck();">중복확인</button>
                                </div>
                                <span id="emailCheckResult" class="check-result"></span>
                                <span class="error">이메일을 입력해주세요.</span>
                            </td>
                        </tr>
        
                        <tr>
                            <th>비밀번호<span class="star">*</span></th>
                            <td>
                                <input type="password" name="password" id="password" class="requiredInfo kurly-input" placeholder="비밀번호를 입력해주세요" />
                                <span class="error">비밀번호를 입력해주세요.</span>
                            </td>
                        </tr>
        
                        <tr>
                            <th>비밀번호확인<span class="star">*</span></th>
                            <td>
                                <input type="password" id="pwdcheck" class="requiredInfo kurly-input" placeholder="비밀번호를 한번 더 입력해주세요" /> 
                                <span class="error">비밀번호가 일치하지 않습니다.</span>
                            </td>
                        </tr>
        
                        <tr>
                            <th>이름<span class="star">*</span></th>
                            <td>
                                <input type="text" name="userName" id="userName" class="requiredInfo kurly-input" placeholder="이름을 입력해주세요" autocomplete="off" /> 
                                <span class="error">성명은 필수입력 사항입니다.</span>
                            </td>
                        </tr>
        
                        <tr>
                            <th>닉네임<span class="star">*</span></th>
                            <td>
                                <div class="input-wrapper">
                                    <input type="text" name="nickname" id="nickname" class="requiredInfo kurly-input" placeholder="사용할 닉네임" autocomplete="off" /> 
                                    <button type="button" class="btn-kurly-outline" onclick="isExistNicknameCheck();">중복확인</button>
                                </div>
                                <span id="nicknameCheckResult" class="check-result"></span>
                                <span class="error">닉네임은 필수입력 사항입니다.</span>
                            </td>
                        </tr>
                        
                        <tr>
                            <th>휴대폰<span class="star">*</span></th>
                            <td>
                                <div class="input-wrapper">
                                    <input type="text" id="phone" name="phone" maxlength="11" class="requiredInfo kurly-input" placeholder="숫자만 입력해주세요" />
                                    <button type="button" class="btn-kurly-outline" onclick="sendSms();">인증번호 받기</button>
                                </div>
                                <div id="smsAuthDiv" style="display: none; margin-top: 10px;" class="input-wrapper">
                                    <input type="text" id="smsCode" class="kurly-input" placeholder="인증번호 입력" />
                                    <button type="button" class="btn-kurly-solid" onclick="verifySms();">확인</button>
                                </div>
                                <span class="error">휴대폰 번호를 입력해주세요.</span>
                            </td>
                        </tr>

                        <tr>
                            <th>주소<span class="star">*</span></th>
                            <td>
                                <button type="button" id="zipcodeSearch" class="btn-kurly-outline btn-full">🔍 주소 검색</button>
                                <div id="addressInputArea" class="address-inputs" style="display: none; margin-top: 15px;">
                                    <input type="text" id="postcode" name="postcode" class="kurly-input postcode-input" placeholder="우편번호" readonly />
                                    <input type="text" id="address" name="address" class="kurly-input" placeholder="기본 주소" readonly style="margin-bottom: 8px;" />
                                    <div class="input-wrapper">
                                        <input type="text" id="detailaddress" name="detailaddress" class="kurly-input" placeholder="상세주소" />
                                        <input type="text" id="extraaddress" name="extraaddress" class="kurly-input" placeholder="참고항목" readonly />
                                    </div>
                                </div>
                            </td>
                        </tr>
                        
                        <tr>
                            <th>성별<span class="star">*</span></th>
                            <td>
                                <div class="gender-box">
                                    <label class="gender-label"><input type="radio" name="gender" id="gender_m" value="M" checked /><span>남자</span></label>
                                    <label class="gender-label"><input type="radio" name="gender" id="gender_f" value="F" /><span>여자</span></label>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <th>생년월일<span class="star">*</span></th>
                            <td>
                                <input type="text" id="birthDate" name="birthDate" class="requiredInfo kurly-input date-input" placeholder="YYYY / MM / DD" readonly />
                                <span class="error">생년월일은 필수입력 사항입니다.</span>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="agree-box">
                    <label class="agree-label"><input type="checkbox" id="agree" /><span>이용약관 및 개인정보수집 동의 <span class="star">*</span></span></label>
                </div>

                <div class="btn-group-bottom">
                    <button type="button" class="btn-submit" onclick="goRegister()">가입하기</button>
                </div>
            </form>
        </div>

        <div id="profileModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>프로필 선택</h3>
                    <button type="button" class="close-btn" onclick="closeProfileModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="avatar-grid" id="avatarList"></div>
                    <div style="text-align: center; margin: 15px 0; color: #aaa; font-size: 12px;">OR</div>
                    <button type="button" class="btn-kurly-outline btn-full" onclick="document.getElementById('attach').click();">
                        <i class="fas fa-upload"></i> 내 PC에서 사진 올리기
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script th:inline="javascript">
    /*<![CDATA[*/
    
	    // --- 중복 확인 체크용 플래그 ---
	    let b_flag_zipcodeSearch_click = false; 
	    let b_flag_emailDuplicate_click = false; 
	    let b_flag_nicknameDuplicate_click = false; 
	    let b_flag_smsAuth_click = false; 
	
	    $(document).ready(function() {
	        // 초기 에러 메시지 모두 숨김
	        $("span.error").hide();
	
	        // 실시간 빨간 글씨 유효성 검사 (포커스 잃을 때)
	        $(".requiredInfo").not("#birthDate").blur(function() {
	            if($(this).val().trim() === "") {
	                $(this).closest('td').find(".error").show();
	            } else {
	                $(this).closest('td').find(".error").hide();
	            }
	        });
	
	        // 비밀번호 확인 실시간 검사
	        $("#pwdcheck").blur(function() {
	            if($("#password").val() !== $(this).val()) {
	                $(this).closest('td').find(".error").text("비밀번호가 일치하지 않습니다.").show();
	            } else {
	                $(this).closest('td').find(".error").hide();
	            }
	        });
	
	        // 봇츠(bottts) 일러스트 50개 자동 생성
	        const avatarContainer = $("#avatarList");
	        for (let i = 1; i <= 50; i++) {
	            const avatarUrl = `https://api.dicebear.com/7.x/bottts/svg?seed=${i}`;
	            avatarContainer.append(`<img src="${avatarUrl}" class="avatar-option" onclick="selectAvatar(this)" />`);
	        }
	
	        // 생년월일 달력 세팅
	        $("#birthDate").datepicker({ 
	            dateFormat: 'yymmdd', 
	            changeYear: true, 
	            changeMonth: true, 
	            yearRange: "1950:2026",
	            onSelect: function(dateText) { 
	                $(this).closest('td').find(".error").hide(); 
	            }
	        });
	
	        // 주소 검색 창 열기
	        $("#zipcodeSearch").click(function() {
	            new daum.Postcode({
	                oncomplete: function(data) {
	                    $("#postcode").val(data.zonecode);
	                    $("#address").val(data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress);
	                    $("#addressInputArea").slideDown("fast");
	                    b_flag_zipcodeSearch_click = true;
	                    $("#detailaddress").focus();
	                }
	            }).open();  
	        });
	    });
	
	    // ================= 프로필 관련 함수 =================
	    function openProfileModal() { $("#profileModal").fadeIn(200); }
	    function closeProfileModal() { $("#profileModal").fadeOut(200); }
	    function selectAvatar(imgElement) {
	        $(".avatar-option").removeClass("selected");
	        $(imgElement).addClass("selected");
	        const selectedUrl = $(imgElement).attr("src");
	        $("#profilePreview").attr("src", selectedUrl);
	        $("#defaultProfile").val(selectedUrl);
	        $("#attach").val(""); 
	        setTimeout(closeProfileModal, 200);
	    }
	    function previewProfileImage(input) {
	        if (input.files && input.files[0]) {
	            var reader = new FileReader();
	            reader.onload = function(e) {
	                $('#profilePreview').attr('src', e.target.result);
	                $("#defaultProfile").val("");
	            }
	            reader.readAsDataURL(input.files[0]);
	            closeProfileModal();
	        }
	    }
	
	    // ================= AJAX 중복 확인 함수 =================
	    function isExistEmailCheck() {
	        const email = $("#email").val().trim();
	        if(email === "") { alert("이메일을 입력하세요."); return; }
	
	        // 이메일 유효성 검사
	        const regExpEmail = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/i;
	        if(!regExpEmail.test(email)) {
	            alert("올바른 이메일 형식이 아닙니다.");
	            $("#email").focus();
	            return;
	        }
	
	        const reqUrl = /*[[@{/security/emailDuplicateCheck}]]*/ '/security/emailDuplicateCheck';
	
	        $.ajax({
	            url: reqUrl, 
	            type: "post",
	            data: {"email": email},
	            dataType: "json",
	            success: function(json) {
	                if(json.isExist) {
	                    $("#emailCheckResult").text("이미 사용 중인 이메일입니다.").css("color", "red");
	                    b_flag_emailDuplicate_click = false;
	                } else {
	                    $("#emailCheckResult").text("사용 가능한 이메일입니다.").css("color", "green");
	                    b_flag_emailDuplicate_click = true;
	                }
	            },
	            error: function() { alert("서버와 통신 중 에러가 발생했습니다."); }
	        });
	    }
	
	    function isExistNicknameCheck() {
	        const nickname = $("#nickname").val().trim();
	        if(nickname === "") { alert("닉네임을 입력하세요."); return; }
	
	        // 닉네임 유효성 검사 (특수문자 제외, 10자리 이하)
	        const regExpNickname = /^[a-zA-Z0-9가-힣]{1,10}$/;
	        if(!regExpNickname.test(nickname)) {
	            alert("닉네임은 특수문자 없이 10자리 이하로 입력해주세요.");
	            $("#nickname").focus();
	            return;
	        }
	
	        const reqUrl = /*[[@{/security/nicknameDuplicateCheck}]]*/ '/security/nicknameDuplicateCheck';
	
	        $.ajax({
	            url: reqUrl, 
	            type: "post",
	            data: {"nickname": nickname},
	            dataType: "json",
	            success: function(json) {
	                if(json.isExist) {
	                    $("#nicknameCheckResult").text("이미 사용 중인 닉네임입니다.").css("color", "red");
	                    b_flag_nicknameDuplicate_click = false;
	                } else {
	                    $("#nicknameCheckResult").text("사용 가능한 닉네임입니다.").css("color", "green");
	                    b_flag_nicknameDuplicate_click = true;
	                }
	            },
	            error: function() { alert("서버와 통신 중 에러가 발생했습니다."); }
	        });
	    }
	
	    function sendSms() { 
	        const phone = $("#phone").val().trim();
	        if(phone === "") { alert("휴대폰 번호를 입력해주세요."); return; }
	
	        // [정규식 추가] 휴대폰 번호 유효성 검사 (11자리 숫자)
	        const regExpPhone = /^[0-9]{11}$/;
	        if(!regExpPhone.test(phone)) {
	            alert("휴대폰 번호는 11자리 숫자만 입력해주세요. (- 제외)");
	            $("#phone").focus();
	            return;
	        }
	
	        const reqUrl = /*[[@{/security/sendSms}]]*/ '/security/sendSms';
	
	        $.ajax({
	            url: reqUrl,
	            type: "post",
	            data: {"phone": phone},
	            dataType: "json",
	            success: function(json) {
	                if(json.success) {
	                    alert(json.msg); 
	                    $("#smsAuthDiv").css("display", "flex"); 
	                    $("#phone").closest('td').find(".error").hide();
	                } else {
	                    alert(json.msg); 
	                    $("#phone").val("");
	                    $("#phone").focus();
	                }
	            },
	            error: function() { alert("서버와 통신 중 에러가 발생했습니다."); }
	        });
	    }
	
	    function verifySms() {
	        const code = $("#smsCode").val().trim();
	        if(code === "") { alert("인증번호를 입력해주세요."); return; }
	
	        const reqUrl = /*[[@{/security/verifySms}]]*/ '/security/verifySms';
	
	        $.ajax({
	            url: reqUrl,
	            type: "post",
	            data: {"code": code},
	            dataType: "json",
	            success: function(json) {
	                if(json.isMatch) {
	                    alert("인증이 완료되었습니다."); 
	                    b_flag_smsAuth_click = true; 
	                    $("#smsCode").attr("readonly", true).css("background-color", "#eee");
	                    $("#phone").attr("readonly", true).css("background-color", "#eee");
	                } else {
	                    alert("인증번호가 일치하지 않습니다. 다시 확인해주세요.");
	                    b_flag_smsAuth_click = false; 
	                }
	            },
	            error: function() { alert("서버와 통신 중 에러가 발생했습니다."); }
	        });
	    }
	
	    // ================= 최종 가입하기 =================
	    function goRegister() {
	        // 필수 입력창 빈칸 재검사
	        let isAllFilled = true;
	        $(".requiredInfo").each(function() {
	            if($(this).val().trim() === "") {
	                $(this).closest('td').find(".error").show();
	                isAllFilled = false;
	            }
	        });
	
	        if(!isAllFilled) { alert("필수 입력사항을 확인해주세요."); return; }
	
	        const email = $("#email").val().trim();
	        const regExpEmail = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/i;
	        if(!regExpEmail.test(email)) {
	            alert("올바른 이메일 형식이 아닙니다.");
	            $("#email").focus();
	            return;
	        }
	
	        const password = $("#password").val();
	        const regExpPw = new RegExp(/^.*(?=^.{8,15}$)(?=.*\d)(?=.*[a-zA-Z])(?=.*[^a-zA-Z0-9]).*$/);
	        if(!regExpPw.test(password)) {
	            alert("비밀번호는 영문, 숫자, 특수문자를 포함하여 8~15자리로 입력해주세요.");
	            $("#password").focus();
	            return;
	        }
	
	        const userName = $("#userName").val().trim();
	        const regExpName = /^[가-힣]{1,6}$/;
	        if(!regExpName.test(userName)) {
	            alert("이름은 한글만 사용하여 6자리 이하로 입력해주세요.");
	            $("#userName").focus();
	            return;
	        }
	
	        const nickname = $("#nickname").val().trim();
	        const regExpNickname = /^[a-zA-Z0-9가-힣]{1,10}$/;
	        if(!regExpNickname.test(nickname)) {
	            alert("닉네임은 특수문자 없이 10자리 이하로 입력해주세요.");
	            $("#nickname").focus();
	            return;
	        }
	
	        const phone = $("#phone").val().trim();
	        const regExpPhone = /^[0-9]{11}$/;
	        if(!regExpPhone.test(phone)) {
	            alert("휴대폰 번호는 11자리 숫자만 입력해주세요. (- 제외)");
	            $("#phone").focus();
	            return;
	        }
	
	        // 3. 중복확인, 인증, 약관 동의 플래그 검사
	        if(!b_flag_emailDuplicate_click) { alert("이메일 중복확인을 완료해주세요."); return; }
	        if(!b_flag_nicknameDuplicate_click) { alert("닉네임 중복확인을 완료해주세요."); return; }
	        if(!b_flag_smsAuth_click) { alert("휴대폰 인증을 완료해주세요."); return; }
	        if(!b_flag_zipcodeSearch_click) { alert("주소검색을 완료해주세요."); return; }
	        if(!$("#agree").is(":checked")) { alert("약관에 동의해주세요."); return; }
	
	        if($("#detailaddress").val().trim() === "") {
	            $("#detailaddress").val(" "); 
	        }
	
	        // 서버로 폼 전송
	        const frm = document.registerFrm;
	        frm.action = /*[[@{/security/registerEnd}]]*/ '/security/registerEnd'; 
	        frm.method = "post";
	        frm.submit();
	    }
	    
	    /*]]>*/
	</script>
</body>
</html>